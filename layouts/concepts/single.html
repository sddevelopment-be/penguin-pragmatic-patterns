{{ define "main" }}
{{ partial "navbar.html" . }}
{{ partial "navbar-clone.html" . }}
{{ $tags := .Params.tags }}
{{ $image := .Params.image }}
{{ $relatedConcepts := .Params.related_concepts }}
{{ $relatedPatterns := .Params.related_practices }}
{{ $further_exploration := .Params.further_exploration }}

<section class="section is-medium">
    <div class="container">
        <div class="columns">
            <div class="title-wrapper has-text-centered increased-width">
                <h1 class="title is-3 section-title">{{ .Title }}</h1>
                <h5 class="subtitle is-4 is-muted">{{ .Params.Subtitle }}</h5>
                <div class="divider spacer spacer-wide"></div>
            </div>
        </div>

        <div class="content pattern">
            {{ .Content }}
        </div>

        <div class="content pattern related">
            {{ if $further_exploration }}
                <h2>Further Exploration</h2>

                <ul>
                    {{ $bibliographicReferences := (apply (where $further_exploration "type" "biblio") "index" "." "id") }}

                    {{ if $bibliographicReferences }}
                        {{ $allBooks := (index .Site.Data "bibliography").book }}
                        {{ $matchingBooks := (where $allBooks "id" "in" $bibliographicReferences ) }}
                        {{ range $book := $matchingBooks }}
                            <li>
                                {{ $book.authors }} ({{ $book.year}}) <a href="/books/{{$book.id}}" rel="noreferrer" target="_blank">{{ $book.title }}</a>. {{ if $book.publisher }} {{ if $book.location }}, {{ $book.location }}:{{ end }} {{ $book.publisher }}. {{if $book.isbn }}isbn: {{$book.isbn}}. {{ end }} {{ end }}
                            </li>
                        {{ end }}
                    {{ end }}

                    {{ $rawReferences := where $further_exploration "type" "raw" }}
                    {{ if $rawReferences }}
                        {{ range $rawReference := $rawReferences }}
                            <li>
                                {{ $rawReference.author }} ({{ $rawReference.year}}). {{ $rawReference.title }}. {{$rawReference.site}}. <a href="{{ $rawReference.link }}" target="_blank" rel="noreferrer"> {{$rawReference.link}}</a>.
                            </li>
                        {{ end }}
                    {{ end }}
                </ul>

            {{ end }}
            {{ if $relatedConcepts }}
                <h2>Related Concepts</h2>
                <ul>
                {{ range where .Site.Pages ".Params.Uuid" "in" $relatedConcepts }}
                    <li><a href="{{ .RelPermalink }}">{{ .Title }}</a>: {{ .Description }}</li>
                {{ end }}
                </ul>
            {{ end }}
            {{ if $relatedPatterns }}
            <h2>Related Patterns</h2>
            <ul>
                {{ range where .Site.Pages ".Params.Uuid" "in" $relatedPatterns }}
                <li><a href="{{ .RelPermalink }}">{{ .Title }}</a>: {{ .Description }}</li>
                {{ end }}
            </ul>
            {{ end }}
        </div>
    </div>
</section>

{{ if .Site.Params.footer }}
    {{ partial "footer.html" . }}
{{ end }}

{{ end }}